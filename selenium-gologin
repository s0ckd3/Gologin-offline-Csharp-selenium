using System;
using System.Collections.Generic;
using System.IO;
using System.Net.Http;
using System.Net.Sockets;
using System.Threading.Tasks;
using Newtonsoft.Json;
using OpenQA.Selenium;
using OpenQA.Selenium.Chrome;
using OpenQA.Selenium.Support.UI;

namespace CSharpWebDriverExample
{
    class Program
    {
        static async Task Main(string[] args)
        {
            string tmpdir = Path.GetTempPath(); // Thay đổi thư mục chứa profiles
            string address = "127.0.0.1";
            List<string> extraParams = new List<string>
            {
                "--disable-site-isolation-trials"
            };
            bool local = false;
            bool credentialsEnableService = false;

            Product starts = new Product(tmpdir, address, extraParams, local, credentialsEnableService);
            string proxyData = null;
            List<string> proxyDataList = new List<string> { "http://192.168.1.111:7101", "http://192.168.1.111:7102" }; // Thay đổi proxy tại đây
            // List<string> proxyDataList = new List<string>(); // Bỏ comment dòng này nếu bạn không có dữ liệu proxy

            if (proxyDataList.Count > 0)
            {
                foreach (var proxyNew in proxyDataList)
                {
                    proxyData = proxyNew;
                }
            }

            string profileId = "98998097614797189124"; // Thay đổi tên Profile ở đây
            starts.SetProfileId(profileId);

            if (!string.IsNullOrEmpty(proxyData))
            {
                starts.ChangeProxy(proxyData);
                starts.Update(profileId);
            }

            Console.WriteLine("Profile start: " + profileId);
            Console.WriteLine("Proxy start: " + proxyData);
            string debuggerAddress = starts.Start();
            Console.WriteLine(debuggerAddress);

            string chromeDriverDirectory = @"Đường_dẫn_đến_thư_mục_chứa_ChromeDriver";
            string chromeDriverPath = Path.Combine(chromeDriverDirectory, "chromedriver.exe");

            // Kiểm tra xem tệp ChromeDriver.exe có tồn tại trong thư mục đã chỉ định không
            if (!File.Exists(chromeDriverPath))
            {
                Console.WriteLine("Không tìm thấy ChromeDriver.exe trong thư mục đã chỉ định.");
                return;
            }
            
            ChromeDriverService chromeDriverService = ChromeDriverService.CreateDefaultService();
            chromeDriverService.HideCommandPromptWindow = true;

            ChromeOptions chromeOptions = new ChromeOptions();
            chromeOptions.AddArgument($"--remote-debugging-port={debuggerAddress}");
            chromeOptions.AddArgument("--user-data-dir=" + starts.ProfilePath);
            chromeOptions.AddArgument("--password-store=basic");
            chromeOptions.AddArgument("--lang=en");

            if (!string.IsNullOrEmpty(proxyData))
            {
                string[] proxyParts = proxyData.Split(new string[] { "://" }, StringSplitOptions.None);
                if (proxyParts.Length == 2)
                {
                    string schema = proxyParts[0];
                    string[] proxyHostPort = proxyParts[1].Split(':');
                    if (proxyHostPort.Length == 2)
                    {
                        string proxyHost = proxyHostPort[0];
                        string proxyPort = proxyHostPort[1];

                        string hrRules = $"\"MAP * 0.0.0.0 , EXCLUDE {proxyHost}\"";
                        chromeOptions.AddArgument($"--proxy-server={proxyData}");
                        chromeOptions.AddArgument("--host-resolver-rules=" + hrRules);
                    }
                }
            }

            foreach (var param in starts.ExtraParams)
            {
                chromeOptions.AddArgument(param);
            }

            using (IWebDriver driver = new ChromeDriver(chromeDriverService, chromeOptions))
            {
                driver.Navigate().GoToUrl("https://accounts.google.com/ServiceLogin?hl=vi");

                WebDriverWait wait = new WebDriverWait(driver, TimeSpan.FromSeconds(10));
                IWebElement loginBox = wait.Until(SeleniumExtras.WaitHelpers.ExpectedConditions.ElementIsVisible(By.Id("identifierId")));
                loginBox.SendKeys("huongthuy70483");
                loginBox.SendKeys(Keys.Enter);

                IWebElement passWordBox = wait.Until(SeleniumExtras.WaitHelpers.ExpectedConditions.ElementIsVisible(By.Name("Passwd")));
                passWordBox.SendKeys("passsss");
                passWordBox.SendKeys(Keys.Enter);

                Console.WriteLine("Press any key to exit...");
                Console.ReadKey();
            }
        }
    }

    public class Product
    {
        public string Tmpdir { get; private set; }
        public string Address { get; private set; }
        public List<string> ExtraParams { get; private set; }
        public bool Local { get; private set; }
        public bool CredentialsEnableService { get; private set; }
        public string ProfilePath { get; private set; }
        public string ExecutablePath { get; private set; }

        public Product(string tmpdir, string address, List<string> extraParams, bool local, bool credentialsEnableService)
        {
            Tmpdir = tmpdir;
            Address = address;
            ExtraParams = extraParams;
            Local = local;
            CredentialsEnableService = credentialsEnableService;
            ExecutablePath = "đường_dẫn_đến_tệp_chrome.exe"; // Thay đổi đường dẫn tới Chrome Browser ở đây
        }

        public void SetProfileId(string profileId)
        {
            ProfilePath = Path.Combine(Tmpdir, profileId);
        }

        public void ChangeProxy(string proxy)
        {
            Proxy = proxy;
            string schema = string.Empty;
            string host = string.Empty;
            string port = string.Empty;
            string username = string.Empty;
            string password = string.Empty;

            if (!string.IsNullOrEmpty(proxy))
            {
                try
                {
                    schema = proxy.Split("://")[0];
                    string[] proxyParts = proxy.Split("://")[1].Split(':');
                    if (proxyParts.Length == 2)
                    {
                        host = proxyParts[0];
                        port = proxyParts[1];
                    }
                    else if (proxyParts.Length == 4)
                    {
                        host = proxyParts[0];
                        port = proxyParts[1];
                        username = proxyParts[2];
                        password = proxyParts[3];
                    }

                    string preferencesPath = Path.Combine(ProfilePath, "Default", "Preferences");

                    if (File.Exists(preferencesPath))
                    {
                        string preferencesContent = File.ReadAllText(preferencesPath);
                        dynamic preferences = JsonConvert.DeserializeObject(preferencesContent);

                        if (preferences != null)
                        {
                            preferences.gologin.proxy = new
                            {
                                id = null,
                                mode = schema,
                                host = host,
                                port = int.Parse(port),
                                username = username,
                                password = password,
                                changeIpUrl = "null",
                                autoProxyRegion = "us",
                                torProxyRegion = "us"
                            };

                            File.WriteAllText(preferencesPath, JsonConvert.SerializeObject(preferences));
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine(ex);
                }
            }
        }

        public void Update(string profileId)
        {
            TimeZoneInfo timeZoneInfo = GetTimeZone();

            if (timeZoneInfo != null)
            {
                ChangeTimeZone(timeZoneInfo);
            }
        }

        private TimeZoneInfo GetTimeZone()
        {
            string url = "https://time.gologin.com";
            string proxyUrl = FormatProxyUrlPassword(Proxy);

            HttpClient httpClient = new HttpClient();

            if (!string.IsNullOrEmpty(proxyUrl))
            {
                httpClient.DefaultRequestHeaders.Add("User-Agent", "gologin-api");
                httpClient.DefaultProxy = new WebProxy(proxyUrl);
            }

            try
            {
                string response = httpClient.GetStringAsync(url).Result;
                dynamic timeZoneData = JsonConvert.DeserializeObject(response);

                if (timeZoneData != null)
                {
                    string timeZoneId = timeZoneData.timezone;
                    return TimeZoneInfo.FindSystemTimeZoneById(timeZoneId);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex);
            }

            return null;
        }

        private void ChangeTimeZone(TimeZoneInfo timeZoneInfo)
        {
            string preferencesPath = Path.Combine(ProfilePath, "Default", "Preferences");

            if (File.Exists(preferencesPath))
            {
                string preferencesContent = File.ReadAllText(preferencesPath);
                dynamic preferences = JsonConvert.DeserializeObject(preferencesContent);

                if (preferences != null)
                {
                    preferences.gologin.timezone.id = timeZoneInfo.Id;

                    File.WriteAllText(preferencesPath, JsonConvert.SerializeObject(preferences));
                }
            }
        }

        public string Start()
        {
            int tryCount = 1;
            string url = $"{Address}:{GetRandomPort()}";

            while (tryCount < 100)
            {
                try
                {
                    using (HttpClient httpClient = new HttpClient())
                    {
                        var data = httpClient.GetStringAsync($"http://{url}/json").Result;
                        Console.WriteLine(data);
                        break;
                    }
                }
                catch
                {
                    tryCount++;
                    Task.Delay(1000).Wait();
                }
            }

            return url;
        }

        private int GetRandomPort()
        {
            Random random = new Random();
            int port = random.Next(1000, 35000);
            using (TcpClient tcpClient = new TcpClient())
            {
                try
                {
                    tcpClient.Connect(Address, port);
                    return GetRandomPort();
                }
                catch
                {
                    return port;
                }
            }
        }

        private string FormatProxyUrlPassword(string proxy)
        {
            if (string.IsNullOrEmpty(proxy))
            {
                return string.Empty;
            }

            string[] proxyParts = proxy.Split(new string[] { "://" }, StringSplitOptions.None);
            if (proxyParts.Length == 2)
            {
                return proxyParts[0] + "://" + proxyParts[1];
            }
            else
            {
                return proxyParts[0] + "://" + proxyParts[2] + ":" + proxyParts[3] + "@" + proxyParts[1];
            }
        }
    }
}
